{
    "stg_movimento_deposito_prazo_atual": {
        "tipo": "stg",
        "tabelas": [
            "stg_movimento_deposito_prazo_atual"
        ],
        "colunas": [
            "carencia_dias",
            "desc_produto",
            "vlr_movimento",
            "num_conta",
            "canal",
            "flg_trava",
            "vlr_taxa",
            "cpf_cnpj",
            "taxa",
            "data_emissao",
            "carencia",
            "cod_agencia",
            "num_titulo",
            "data_movimento",
            "tipo_movimento",
            "ano_mes"
        ],
        "codigo_m": "let\n    Fonte = Excel.Workbook(Web.Contents(\"https://confederacaosicredi.sharepoint.com/teams/0802-BI/Shared%20Documents/Sync/01-Bases/02-Denodo/denodo_movimentos_deposito_prazo_atual.xlsx\"), null, true),\n    ldw_movimentos_deposito_prazo_a1 = Fonte{[Name=\"Sheet1\"]}[Data],\n    #\"Cabeçalhos Promovidos\" = Table.PromoteHeaders(ldw_movimentos_deposito_prazo_a1, [PromoteAllScalars=true]),\n    #\"Tipo Alterado\" = Table.TransformColumnTypes(#\"Cabeçalhos Promovidos\", {\n        {\"ano_mes\", Int64.Type}, {\"data_movimento\", type date}, {\"cod_cooperativa\", Int64.Type},\n        {\"cod_agencia\", Int64.Type}, {\"cpf_cnpj\", type text}, {\"num_conta\", type text},\n        {\"origem\", type text}, {\"tipo_movimento\", type text}, {\"tipo_lancamento\", type text},\n        {\"segmento\", type text}, {\"porte_padrao\", type text}, {\"num_titulo\", type text},\n        {\"cod_produto\", Int64.Type}, {\"desc_produto\", type text}, {\"canal\", type text},\n        {\"cod_usuario\", type text}, {\"vlr_movimento\", type number}, {\"taxa\", type number},\n        {\"carencia\", Int64.Type}, {\"flg_trava\", type text}\n    }),\n    #\"Colunas Selecionadas\" = Table.SelectColumns(#\"Tipo Alterado\", {\n        \"ano_mes\", \"data_movimento\", \"cod_agencia\", \"cpf_cnpj\", \"num_conta\", \"tipo_movimento\",\n        \"num_titulo\", \"desc_produto\", \"canal\", \"vlr_movimento\", \"taxa\", \"carencia\", \"flg_trava\"\n    }),\n    #\"Flag Trava Padronizada1\" = Table.ReplaceValue(#\"Colunas Selecionadas\", \"S\", \"Sim\", Replacer.ReplaceText, {\"flg_trava\"}),\n    #\"Flag Trava Padronizada2\" = Table.ReplaceValue(#\"Flag Trava Padronizada1\", \"N\", \"Não\", Replacer.ReplaceText, {\"flg_trava\"}),\n    #\"Tipo Investimento Adicionado\" = Table.AddColumn(#\"Flag Trava Padronizada2\", \"tipo_investimento\", each \"DP\"),\n    #\"Colunas Renomeadas\" = Table.RenameColumns(#\"Tipo Investimento Adicionado\", {\n        {\"carencia\", \"carencia_dias\"}, {\"data_movimento\", \"data_emissao\"}, {\"taxa\", \"vlr_taxa\"}\n    })\nin\n    #\"Colunas Renomeadas\" // stg_movimento_deposito_prazo_atual"
    },
    "stg_movimento_fundo_atual": {
        "tipo": "stg",
        "tabelas": [
            "stg_movimento_fundo_atual"
        ],
        "colunas": [
            "num_operacao",
            "tipo_lancamento",
            "cod_usuario",
            "ano_mes",
            "vlr_movimento",
            "num_conta",
            "canal",
            "cod_produto",
            "data_emissao",
            "tipo_movimento",
            "porte_padrao",
            "cod_cooperativa",
            "produto",
            "segmento",
            "nome_produto",
            "origem",
            "cpf_cnpj",
            "cod_agencia",
            "num_titulo",
            "data_movimento"
        ],
        "codigo_m": "let\n    Fonte = Excel.Workbook(Web.Contents(\"https://confederacaosicredi.sharepoint.com/teams/0802-BI/Shared%20Documents/Sync/01-Bases/02-Denodo/denodo_movimentos_fundos_atual.xlsx\"), null, true),\n    Sheet1_Sheet = Fonte{[Item=\"Sheet1\",Kind=\"Sheet\"]}[Data],\n    #\"Cabeçalhos Promovidos\" = Table.PromoteHeaders(Sheet1_Sheet, [PromoteAllScalars=true]),\n    #\"Colunas Selecionadas\" = Table.SelectColumns(#\"Cabeçalhos Promovidos\", {\n        \"ano_mes\", \"data_movimento\", \"cod_cooperativa\", \"cod_agencia\", \"cpf_cnpj\", \"num_conta\",\n        \"origem\", \"tipo_movimento\", \"tipo_lancamento\", \"segmento\", \"porte_padrao\", \"num_titulo\",\n        \"cod_produto\", \"nome_produto\", \"canal\", \"cod_usuario\", \"vlr_movimento\"\n    }),\n    #\"Tipo Alterado\" = Table.TransformColumnTypes(#\"Colunas Selecionadas\", {\n        {\"ano_mes\", type text}, {\"data_movimento\", type date}, {\"cod_cooperativa\", type text},\n        {\"cod_agencia\", type text}, {\"cpf_cnpj\", type text}, {\"num_conta\", type text},\n        {\"origem\", type text}, {\"tipo_movimento\", type text}, {\"tipo_lancamento\", type text},\n        {\"segmento\", type text}, {\"porte_padrao\", type text}, {\"num_titulo\", type text},\n        {\"cod_produto\", type text}, {\"nome_produto\", type text}, {\"canal\", type text},\n        {\"cod_usuario\", type text}, {\"vlr_movimento\", type number}\n    }),\n    #\"Tipo Investimento Adicionado\" = Table.AddColumn(#\"Tipo Alterado\", \"tipo_investimento\", each \"Fundos\"),\n    #\"Colunas Renomeadas\" = Table.RenameColumns(#\"Tipo Investimento Adicionado\", {\n        {\"nome_produto\", \"produto\"}, {\"data_movimento\", \"data_emissao\"}, {\"num_titulo\", \"num_operacao\"}\n    }),\n    #\"Flag Trava Adicionada\" = Table.AddColumn(#\"Colunas Renomeadas\", \"flg_trava\", each \"Não\")\nin\n    #\"Flag Trava Adicionada\" // stg_movimento_fundo_atual\n"
    },
    "f_movimento_geral": {
        "tipo": "fato",
        "tabelas": [
            "fato_movimento_geral"
        ],
        "colunas": [
            "emissor",
            "flg_trava",
            "num_operacao",
            "taxa",
            "tipo_lancamento",
            "carencia",
            "data_vencimento",
            "cod_usuario",
            "ano_mes",
            "tipo_investimento",
            "carencia_dias",
            "vlr_movimento",
            "num_conta",
            "canal",
            "data_emissao",
            "cod_produto",
            "tipo_movimento",
            "porte_padrao",
            "DEPOSITO CHEQUE BLOQUEADO",
            "desc_produto",
            "vlr_taxa",
            "cod_ag",
            "data_carencia",
            "cod_cooperativa",
            "cod_operacao_lastro",
            "data_aplicacao",
            "produto",
            "filtro_ano_mes_final",
            "segmento",
            "origem",
            "filtro_ano_mes_inicial",
            "cpf_cnpj",
            "cod_agencia",
            "num_titulo"
        ],
        "codigo_m": "let\n    // 1. União das stg_ atual + mensal (ordenadas alfabeticamente)\n    Fonte = Table.Combine({\n        stg_movimento_deposito_prazo_atual,\n        stg_movimento_deposito_prazo_mensal,\n        stg_movimento_fundo_atual,\n        stg_movimento_fundo_mensal,\n        stg_movimento_lca_atual,\n        stg_movimento_lca_mensal,\n        stg_movimento_lci_atual,\n        stg_movimento_lci_mensal,\n        stg_movimento_poupanca_atual,\n        stg_movimento_poupanca_mensal\n    }),\n    #\"Outras Colunas Removidas\" = Table.SelectColumns(Fonte,{\"ano_mes\", \"data_emissao\", \"cod_agencia\", \"cpf_cnpj\", \"num_conta\", \"tipo_movimento\", \"num_titulo\", \"desc_produto\", \"canal\", \"vlr_movimento\", \"vlr_taxa\", \"carencia_dias\", \"flg_trava\", \"tipo_investimento\", \"carencia\", \"cod_cooperativa\", \"origem\", \"tipo_lancamento\", \"segmento\", \"porte_padrao\", \"num_operacao\", \"cod_produto\", \"produto\", \"cod_usuario\", \"taxa\", \"emissor\", \"data_aplicacao\", \"data_vencimento\", \"data_carencia\", \"cod_ag\", \"cod_operacao_lastro\", \"filtro_ano_mes_inicial\", \"filtro_ano_mes_final\"}),\n\n    // 2. Padronização de tipo_movimento\n    #\"Tipo Movimento Padronizado\" = Table.ReplaceValue(#\"Outras Colunas Removidas\", each [tipo_movimento],\n        each if List.Contains({\"Resgate pelo valor bruto\", \"Resgate total\", \"Resgate pelo valor liquido\", \"Resgate para pagamento de IR\", \"DEBITO\", \"VALORIZACAO\", \"OUTROS\"}, [tipo_movimento]) then \"RESGATE\"\n        else if List.Contains({\"CREDITO\", \"DEPOSITO CHEQUE BLOQUEADO\"}, [tipo_movimento]) then \"APLICACAO\"\n        else [tipo_movimento],\n        Replacer.ReplaceText, {\"tipo_movimento\"}\n    ),\n\n    // 3. Criação de vlr_ajuste_resgate\n    #\"Valor Ajustado\" = Table.AddColumn(#\"Tipo Movimento Padronizado\", \"vlr_ajuste_resgate\", each \n        if [tipo_movimento] = \"RESGATE\" then [vlr_movimento] * -1 else [vlr_movimento], type number),\n\n    // 4. Agrupamento de taxa (apenas para tipo_investimento = \"DP\")\n    #\"Taxa Agrupada\" = Table.AddColumn(#\"Valor Ajustado\", \"Taxa_Agrup\", each \n        if [tipo_investimento] = \"DP\" then\n            if [vlr_taxa] >= 120 then \"120%\"\n            else if [vlr_taxa] >= 110 then \"110%\"\n            else if [vlr_taxa] >= 107 then \"107%\"\n            else if [vlr_taxa] >= 105 then \"105%\"\n            else if [vlr_taxa] >= 100 then \"100%\"\n            else \"<100%\"\n        else null, type text),\n\n    #\"Ordem Taxa Agrup\" = Table.AddColumn(#\"Taxa Agrupada\", \"Ordem Taxa Agrup\", each \n        if [Taxa_Agrup] = \"<100%\" then 1\n        else if [Taxa_Agrup] = \"100%\" then 2\n        else if [Taxa_Agrup] = \"105%\" then 3\n        else if [Taxa_Agrup] = \"107%\" then 4\n        else if [Taxa_Agrup] = \"110%\" then 5\n        else if [Taxa_Agrup] = \"120%\" then 6\n        else if [tipo_investimento] = \"DP\" then 7\n        else null, type number),\n\n    // 5. Campo Apto (apenas para DP)\n    #\"Apto Adicionado\" = Table.AddColumn(#\"Ordem Taxa Agrup\", \"Apto\", each \n        if [tipo_investimento] = \"DP\" and [flg_trava] = \"Não\" and [vlr_taxa] >= 120 then \"Não\"\n        else if [tipo_investimento] = \"DP\" then \"Sim\"\n        else null),\n\n    // 6. Garantia de tipo numérico para vlr_movimento\n    #\"Tipo Corrigido\" = Table.TransformColumnTypes(#\"Apto Adicionado\",{{\"vlr_movimento\", type number}, {\"data_emissao\", type date}})\nin\n    #\"Tipo Corrigido\" // fato_movimento_geral"
    }
}